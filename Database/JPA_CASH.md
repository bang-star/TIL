# JPA CASH

## Preview
- 1차 캐시와 2차 캐시
 ```
   네트워크를 통해 데이터베이스에 접근하는 시간 비용은 애플리케이션 서버 내부 메모리에 접근하는 시간보다 훨씬 비싸다.
   조회한 데이터를 메모리에 캐싱해 두면 데이터베이스 접근 횟수를 줄여 성능을 개선할 수 있다.
 ```

<br />
<hr />
<br />

 ## 1차 캐시
<br />
<img src="https://blog.kakaocdn.net/dn/bfygws/btqXZJabbrb/vwIQ6WAapW6nTSWjd8SiD1/img.png" width=600>
<br />

- 영속성 컨텍스트 내부에는 엔티티를 보관하는 저장소가 있는데 이를 1차 캐시라고 한다.
- 트랜잭션을 시작하고 종료할 때까지 1차 캐시가 유효하다.
- OSIV(Open Session In View)를 사용하더라도 사용자의 요청이 들어올 때부터 끝날 때까지만 1차 캐시가 유효하다.

> 객체 동일성 보장

<br />
<hr />
<br />

## 2차 캐시
<br />
<img src="https://blog.kakaocdn.net/dn/cIWDS5/btriRz5c2sW/qpx44S6WafrLJkHVUb41aK/img.png" width=600>
<br />

- 애플리케이션 범위의 캐시로, 공유시라고도 하며 애플리케이션을 종료할 때까지 캐시가 유지된다.

1. 동시성을 극대화하기 위해 캐시 한 객체를 직접반환하지 않고 복사본을 만들어서 반환한다.
- 복사본을 반환하는 이유는 캐시 한 객체를 그대로반환하면 여러 곳에서 같은 객체를 동시에 수정하는 동시성 문제가 발생할 수 있기 때문이다.
2. 동시성 문제를 해결하기 위해 객체에 락을 걸어야하는데 이는 동시성이 떨어질 수 있다. 
(동시성 제어하는 방식은 여러가지가 있는데, 동시성 제어에 대해 추후 자세히 다루도록 하겠다.)
3. 이 문제를 해결하기 위해 2차 캐시는 원본 대신에 복사본을 반환한다. 
> 영속성 컨텍스가 다르면 객체 동일성을 보장하지 않는다